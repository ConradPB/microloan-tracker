<!DOCTYPE html>
<html>
<head>
    <title>Microloan Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #fff;
            --text-color: #333;
            --card-bg: #f8f9fa;
            --btn-primary-bg: #007bff;
            --btn-primary-text: #fff;
            --badge-success-bg: #28a745;
            --badge-secondary-bg: #6c757d;
        }
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --card-bg: #2c2c2c;
            --btn-primary-bg: #4dabf7;
            --btn-primary-text: #fff;
            --badge-success-bg: #55e080;
            --badge-secondary-bg: #adb5bd;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        .card, .card-stats { background-color: var(--card-bg); }
        .btn-primary { background-color: var(--btn-primary-bg); color: var(--btn-primary-text); }
        .badge.bg-success { background-color: var(--badge-success-bg) !important; }
        .badge.bg-secondary { background-color: var(--badge-secondary-bg) !important; }
        .total { 
            font-size: 1.2em; 
            color: var(--text-color); 
            font-weight: 500; 
        }
        .total strong { 
            color: var(--text-color); 
            font-weight: 700; 
        }
        .overdue { color: #dc3545; }
        .list-group-item:hover { background-color: #e9ecef; }
        [data-theme="dark"] .list-group-item:hover { background-color: #3a3a3a; }
        .chart-container { max-width: 400px; margin: 20px auto; height: 300px; }
        .theme-toggle { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            font-size: 1.2em; 
            padding: 5px 10px; 
        }
    </style>
</head>
<body>
    <button class="btn btn-secondary theme-toggle" id="themeToggle" aria-label="Toggle Theme"><span id="themeIcon"></span></button>
    
    {{ chart_data|json_script:"chart-data" }}
    <script>
        function promptEdit(button) {
            let form = button.form;
            let borrower = prompt("Edit Borrower:", form.querySelector('[name=borrower]').value);
            let amount = prompt("Edit Amount:", form.querySelector('[name=amount]').value);
            let due_date = prompt("Edit Due Date (YYYY-MM-DD):", form.querySelector('[name=due_date]').value);
            let status = prompt("Edit Status (Active/Paid):", form.querySelector('[name=status]').value);
            let category = prompt("Edit Category (Personal/Business):", form.querySelector('[name=category]').value);

            if (!borrower || borrower.trim() === '') {
                alert("Borrower name cannot be empty.");
                return;
            }
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                alert("Amount must be a positive number.");
                return;
            }
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            if (due_date && !dateRegex.test(due_date)) {
                alert("Invalid date format. Please use YYYY-MM-DD (e.g., 2025-08-20).");
                return;
            }
            if (!['Active', 'Paid'].includes(status)) {
                alert("Status must be 'Active' or 'Paid'.");
                return;
            }
            if (!['Personal', 'Business'].includes(category)) {
                alert("Category must be 'Personal' or 'Business'.");
                return;
            }

            form.querySelector('[name=borrower]').value = borrower;
            form.querySelector('[name=amount]').value = amount;
            form.querySelector('[name=due_date]').value = due_date || '';
            form.querySelector('[name=status]').value = status;
            form.querySelector('[name=category]').value = category;
            form.submit();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const toggleButton = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const html = document.documentElement;
            const savedTheme = document.cookie.split('; ').find(row => row.startsWith('theme='));
            const initialTheme = savedTheme ? savedTheme.split('=')[1] : (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            html.setAttribute('data-theme', initialTheme);
            themeIcon.textContent = initialTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';

            toggleButton.addEventListener('click', function() {
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                html.setAttribute('data-theme', newTheme);
                themeIcon.textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                document.cookie = `theme=${newTheme}; path=/; max-age=31536000`;
            });

            const chartDataRaw = document.getElementById('chart-data').textContent;
            const chartData = JSON.parse(chartDataRaw);
            const ctx = document.getElementById('loanChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Active', 'Paid'],
                    datasets: [{
                        data: [chartData.active || 0, chartData.paid || 0],
                        backgroundColor: ['#28a745', '#6c757d']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } }
                }
            });
        });
    </script>
</body>
</html>